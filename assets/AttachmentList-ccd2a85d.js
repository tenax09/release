import{r as E,_ as q}from"./index-5e7125b4.js";/* empty css                   *//* empty css                    *//* empty css                 */import{r as w,w as A,l as s,p as f,G as _,C as l,O as $,D as v,S as x,F as p,u as g,aM as G,af as H,B as r,H as J,I as K,X as O,Q as D,a$ as Q,b0 as W,E as C,J as X,ar as R,a2 as Y,aJ as Z,K as ee,M as te,ai as ae}from"./element-plus-b8725afa.js";import{f as se}from"./format-20468769.js";function le(i){return E({url:"/api/admin/attachments",method:"get",params:i})}function ie(i){return E({url:`/api/admin/attachments/${i}`,method:"delete"})}function De(i,b,c){return E({url:`/api/admin/orders/${i}/upload?ref_id=${b}`,method:"post",data:c,headers:{"Content-Type":"multipart/form-data"}})}const oe={class:"attachment-list-container"},ne={class:"attachment-content"},re={key:0,class:"empty-attachments"},ce={key:1,class:"attachment-grid"},de=["onClick"],ue={key:0,class:"image-preview"},_e=["src","alt"],pe={key:1,class:"file-preview"},me={class:"file-icon"},fe={class:"file-type"},ve={class:"attachment-info"},ge=["title"],he={class:"file-meta"},ye={class:"file-size"},ke={key:0,class:"file-remark"},we={class:"upload-time"},be={key:0,class:"attachment-checkbox"},Be={class:"dialog-footer"},$e={__name:"AttachmentList",props:{visible:{type:Boolean,default:!1},title:{type:String,default:"附件列表"},attachments:{type:Array,default:()=>[]},orderId:{type:[String,Number],required:!0},refId:{type:[String,Number],default:0},type:{type:String,default:"general"},allowDelete:{type:Boolean,default:!0}},emits:["update:visible"],setup(i,{emit:b}){const c=i,I=b,h=w(!1),o=w([]),y=w([]),k=w(!1);A(()=>c.visible,e=>{h.value=e}),A(h,e=>{I("update:visible",e),e&&B()});const B=async()=>{if(!c.orderId){y.value=[];return}k.value=!0;try{const e=await le({order_id:c.orderId,ref_id:c.refId,type:c.type});y.value=e.data||[]}catch(e){console.error("获取附件列表失败:",e),y.value=[]}k.value=!1},L=e=>{var t;return e.file_type==="image"||((t=e.content_type)==null?void 0:t.startsWith("image/"))||/\.(jpg|jpeg|png|gif|bmp|webp|svg)$/i.test(e.file_name)},S=(e,t=200,n=200)=>`/api/admin/attachments/${e}/thumbnail?width=${t}&height=${n}`,T=e=>({document:"文档",image:"图片",video:"视频",audio:"音频",archive:"压缩包"})[e]||"文件",z=e=>{if(!e)return"0 B";const t=1024,n=["B","KB","MB","GB"],d=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,d)).toFixed(2))+" "+n[d]},F=e=>{const t=`/api/admin/attachments/${e.id}/view`;window.open(t,"_blank")},M=()=>{h.value=!1},N=async()=>{if(c.allowDelete){if(o.value.length===0){C.warning("请先选择要删除的附件");return}try{await X.confirm(`确定要删除选中的 ${o.value.length} 个附件吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=o.value.map(u=>ie(u).catch(m=>(console.error(`删除附件 ${u} 失败:`,m),{id:u,success:!1,error:m}))),n=(await Promise.allSettled(e)).filter(u=>u.status==="fulfilled"&&!u.value.error).length,d=o.value.length-n;o.value=[],d===0?C.success(`成功删除 ${n} 个附件`):C.warning(`删除完成：成功 ${n} 个，失败 ${d} 个`),await B()}catch{}}},P=e=>{e.target.style.display="none";const t=e.target.parentElement;t&&(t.innerHTML=`
      <div class="file-preview">
        <div class="file-icon">
          <el-icon size="32">
            <Picture />
          </el-icon>
        </div>
        <div class="file-type">图片加载失败</div>
      </div>
    `)};return(e,t)=>{const n=R,d=Y,u=Z,m=ee,U=te,j=ae;return s(),f(U,{modelValue:h.value,"onUpdate:modelValue":t[1]||(t[1]=a=>h.value=a),title:i.title,width:"90%","before-close":M,center:""},{footer:_(()=>[l("span",Be,[i.allowDelete&&o.value.length>0?(s(),f(m,{key:0,type:"danger",onClick:N},{default:_(()=>[$(" 删除选中 ("+v(o.value.length)+") ",1)]),_:1})):x("",!0),p(m,{type:"primary",onClick:B,loading:k.value},{default:_(()=>[p(d,null,{default:_(()=>[p(g(G))]),_:1}),t[2]||(t[2]=$(" 刷新 "))]),_:1,__:[2]},8,["loading"]),p(m,{onClick:M},{default:_(()=>t[3]||(t[3]=[$("关闭")])),_:1,__:[3]})])]),default:_(()=>[H((s(),r("div",oe,[l("div",ne,[y.value.length===0?(s(),r("div",re,[p(n,{description:"暂无附件"})])):(s(),r("div",ce,[(s(!0),r(J,null,K(y.value,a=>(s(),r("div",{key:a.id,class:O(["attachment-item",{selected:o.value.includes(a.id)}])},[l("div",{class:"attachment-preview",onClick:V=>F(a)},[L(a)?(s(),r("div",ue,[l("img",{src:S(a.id),alt:a.file_name,class:"thumbnail-image",onError:P},null,40,_e)])):(s(),r("div",pe,[l("div",me,[p(d,{size:"32"},{default:_(()=>[a.file_type==="document"?(s(),f(g(D),{key:0})):a.file_type==="image"?(s(),f(g(Q),{key:1})):a.file_type==="video"?(s(),f(g(W),{key:2})):(s(),f(g(D),{key:3}))]),_:2},1024)]),l("div",fe,v(T(a.file_type)),1)]))],8,de),l("div",ve,[l("div",{class:"file-name",title:a.file_name},v(a.file_name),9,ge),l("div",he,[l("span",ye,v(z(a.file_size)),1),a.remark?(s(),r("span",ke,v(a.remark),1)):x("",!0),l("span",we,v(g(se)(a.created_at)),1)])]),i.allowDelete?(s(),r("div",be,[p(u,{modelValue:o.value,"onUpdate:modelValue":t[0]||(t[0]=V=>o.value=V),value:a.id},null,8,["modelValue","value"])])):x("",!0)],2))),128))]))])])),[[j,k.value]])]),_:1},8,["modelValue","title"])}}},Ie=q($e,[["__scopeId","data-v-190b98eb"]]);export{Ie as A,De as u};
