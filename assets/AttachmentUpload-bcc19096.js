import{r as K,_ as H}from"./index-78e7e5a9.js";/* empty css               *//* empty css                        *//* empty css                 */import{r as k,w as S,l as s,p as B,G as o,C as n,O as y,D as w,S as z,F as r,u as $,aM as Q,af as Y,B as _,H as G,I as j,X as Z,Q as W,aX as ee,aY as te,E as C,J as le,ar as ae,a2 as J,aJ as se,K as O,M as X,ai as oe,j as ne,aw as ie,aZ as re,aC as de,aD as ue,a5 as ce,a_ as pe,a$ as _e,b0 as me}from"./element-plus-e0a6c12c.js";import{f as fe}from"./format-20468769.js";/* empty css                     *//* empty css                   *//* empty css                    */function ve(c){return K({url:"/api/admin/attachments",method:"get",params:c})}function ge(c){return K({url:`/api/admin/attachments/${c}`,method:"delete"})}function he(c,D,p){return K({url:`/api/admin/orders/${c}/upload?ref_id=${D}`,method:"post",data:p,headers:{"Content-Type":"multipart/form-data"}})}const ye={class:"attachment-list-container"},we={class:"attachment-content"},ke={key:0,class:"empty-attachments"},be={key:1,class:"attachment-grid"},Be=["onClick"],$e={key:0,class:"image-preview"},Ce=["src","alt"],Me={key:1,class:"file-preview"},xe={class:"file-icon"},De={class:"file-type"},Ee={class:"attachment-info"},Ve=["title"],Ie={class:"file-meta"},ze={class:"file-size"},Se={key:0,class:"file-remark"},Fe={class:"upload-time"},Ae={key:0,class:"attachment-checkbox"},Ue={class:"dialog-footer"},Le={__name:"AttachmentList",props:{visible:{type:Boolean,default:!1},title:{type:String,default:"附件列表"},attachments:{type:Array,default:()=>[]},orderId:{type:[String,Number],required:!0},refId:{type:[String,Number],default:0},type:{type:String,default:"general"},allowDelete:{type:Boolean,default:!0}},emits:["update:visible"],setup(c,{emit:D}){const p=c,E=D,m=k(!1),d=k([]),h=k([]),i=k(!1);S(()=>p.visible,e=>{m.value=e}),S(m,e=>{E("update:visible",e),e&&b()});const b=async()=>{if(!p.orderId){h.value=[];return}i.value=!0;try{const e=await ve({order_id:p.orderId,ref_id:p.refId,type:p.type});h.value=e.data||[]}catch(e){console.error("获取附件列表失败:",e),h.value=[]}i.value=!1},F=e=>{var t;return e.file_type==="image"||((t=e.content_type)==null?void 0:t.startsWith("image/"))||/\.(jpg|jpeg|png|gif|bmp|webp|svg)$/i.test(e.file_name)},A=(e,t=200,u=200)=>`/api/admin/attachments/${e}/thumbnail?width=${t}&height=${u}`,U=e=>({document:"文档",image:"图片",video:"视频",audio:"音频",archive:"压缩包"})[e]||"文件",L=e=>{if(!e)return"0 B";const t=1024,u=["B","KB","MB","GB"],f=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,f)).toFixed(2))+" "+u[f]},N=e=>{const t=`/api/admin/attachments/${e.id}/view`;window.open(t,"_blank")},V=()=>{m.value=!1},T=async()=>{if(p.allowDelete){if(d.value.length===0){C.warning("请先选择要删除的附件");return}try{await le.confirm(`确定要删除选中的 ${d.value.length} 个附件吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=d.value.map(v=>ge(v).catch(g=>(console.error(`删除附件 ${v} 失败:`,g),{id:v,success:!1,error:g}))),u=(await Promise.allSettled(e)).filter(v=>v.status==="fulfilled"&&!v.value.error).length,f=d.value.length-u;d.value=[],f===0?C.success(`成功删除 ${u} 个附件`):C.warning(`删除完成：成功 ${u} 个，失败 ${f} 个`),await b()}catch{}}},l=e=>{e.target.style.display="none";const t=e.target.parentElement;t&&(t.innerHTML=`
      <div class="file-preview">
        <div class="file-icon">
          <el-icon size="32">
            <Picture />
          </el-icon>
        </div>
        <div class="file-type">图片加载失败</div>
      </div>
    `)};return(e,t)=>{const u=ae,f=J,v=se,g=O,R=X,q=oe;return s(),B(R,{modelValue:m.value,"onUpdate:modelValue":t[1]||(t[1]=a=>m.value=a),title:c.title,width:"90%","before-close":V,center:""},{footer:o(()=>[n("span",Ue,[c.allowDelete&&d.value.length>0?(s(),B(g,{key:0,type:"danger",onClick:T},{default:o(()=>[y(" 删除选中 ("+w(d.value.length)+") ",1)]),_:1})):z("",!0),r(g,{type:"primary",onClick:b,loading:i.value},{default:o(()=>[r(f,null,{default:o(()=>[r($(Q))]),_:1}),t[2]||(t[2]=y(" 刷新 "))]),_:1,__:[2]},8,["loading"]),r(g,{onClick:V},{default:o(()=>t[3]||(t[3]=[y("关闭")])),_:1,__:[3]})])]),default:o(()=>[Y((s(),_("div",ye,[n("div",we,[h.value.length===0?(s(),_("div",ke,[r(u,{description:"暂无附件"})])):(s(),_("div",be,[(s(!0),_(G,null,j(h.value,a=>(s(),_("div",{key:a.id,class:Z(["attachment-item",{selected:d.value.includes(a.id)}])},[n("div",{class:"attachment-preview",onClick:I=>N(a)},[F(a)?(s(),_("div",$e,[n("img",{src:A(a.id),alt:a.file_name,class:"thumbnail-image",onError:l},null,40,Ce)])):(s(),_("div",Me,[n("div",xe,[r(f,{size:"32"},{default:o(()=>[a.file_type==="document"?(s(),B($(W),{key:0})):a.file_type==="image"?(s(),B($(ee),{key:1})):a.file_type==="video"?(s(),B($(te),{key:2})):(s(),B($(W),{key:3}))]),_:2},1024)]),n("div",De,w(U(a.file_type)),1)]))],8,Be),n("div",Ee,[n("div",{class:"file-name",title:a.file_name},w(a.file_name),9,Ve),n("div",Ie,[n("span",ze,w(L(a.file_size)),1),a.remark?(s(),_("span",Se,w(a.remark),1)):z("",!0),n("span",Fe,w($(fe)(a.created_at)),1)])]),c.allowDelete?(s(),_("div",Ae,[r(v,{modelValue:d.value,"onUpdate:modelValue":t[0]||(t[0]=I=>d.value=I),value:a.id},null,8,["modelValue","value"])])):z("",!0)],2))),128))]))])])),[[q,i.value]])]),_:1},8,["modelValue","title"])}}},lt=H(Le,[["__scopeId","data-v-190b98eb"]]);const Ne={class:"upload-content"},Te={key:0,class:"attachment-files"},Re={class:"file-list"},qe={class:"file-info"},Ge={class:"file-name"},je={class:"file-size"},Ke={class:"file-remark"},Pe={class:"dialog-footer"},We={__name:"AttachmentUpload",props:{visible:{type:Boolean,default:!1},title:{type:String,default:"上传附件"},orderId:{type:[String,Number],required:!0},refId:{type:[String,Number],required:!0},type:{type:String,default:"order"}},emits:["update:visible","success"],setup(c,{emit:D}){const p=c,E=D,m=k(!1),d=k(null),h=k(!1),i=k([]),b=k([]);S(()=>p.visible,l=>{m.value=l,l&&(i.value=[],b.value=[])}),S(m,l=>{E("update:visible",l)});const F=ne(()=>{switch(p.type){case"car":return[{value:"行驶证",label:"行驶证"},{value:"驾驶证",label:"驾驶证"},{value:"投保单",label:"投保单"},{value:"其他",label:"其他"}];case"cargo":return[{value:"运单",label:"运单"},{value:"发货单",label:"发货单"},{value:"货物清单",label:"货物清单"},{value:"投保单",label:"投保单"},{value:"其他",label:"其他"}];case"received":return[{value:"收款凭证",label:"收款凭证"},{value:"其他",label:"其他"}];default:return[{value:"缴费通知书",label:"缴费通知书"},{value:"其他文件",label:"其他文件"}]}}),A=l=>{if(l.raw.size>10*1024*1024)return C.error("文件大小不能超过10MB"),!1;i.value.push({raw:l.raw,name:l.name,size:l.raw.size,remark:""})},U=l=>{const e=i.value.findIndex(t=>t.name===l.name);e!==-1&&i.value.splice(e,1)},L=(l,e)=>{e!==void 0&&i.value[e]&&(i.value[e].remark=l)},N=l=>{if(l===0)return"0 B";const e=1024,t=["B","KB","MB","GB"],u=Math.floor(Math.log(l)/Math.log(e));return parseFloat((l/Math.pow(e,u)).toFixed(2))+" "+t[u]},V=()=>{m.value=!1,i.value=[],b.value=[],d.value&&d.value.clearFiles()},T=async()=>{if(i.value.length===0){C.error("请选择要上传的文件");return}if(i.value.filter(e=>!e.remark.trim()).length>0){C.error("请为所有文件填写备注");return}h.value=!0;try{for(const e of i.value){const t=new FormData;t.append("files",e.raw),t.append("remarks",e.remark),await he(p.orderId,p.refId,t)}C.success("附件上传成功"),m.value=!1,i.value=[],b.value=[],E("success")}catch(e){C.error("附件上传失败："+(e.message||"未知错误"))}h.value=!1};return(l,e)=>{const t=J,u=de,f=ue,v=ce,g=O,R=pe,q=_e,a=me,I=X;return s(),B(I,{modelValue:m.value,"onUpdate:modelValue":e[0]||(e[0]=x=>m.value=x),title:c.title,width:"900px",center:""},{footer:o(()=>[n("span",Pe,[r(g,{onClick:V},{default:o(()=>e[5]||(e[5]=[y("取消")])),_:1,__:[5]}),r(g,{type:"primary",onClick:T,loading:h.value,disabled:i.value.length===0},{default:o(()=>e[6]||(e[6]=[y(" 开始上传 ")])),_:1,__:[6]},8,["loading","disabled"])])]),default:o(()=>[n("div",Ne,[r(u,{ref_key:"uploadRef",ref:d,class:"upload-demo",drag:"",multiple:"","auto-upload":!1,limit:10,accept:"*/*","on-change":A,"on-remove":U,"file-list":b.value},{tip:o(()=>e[1]||(e[1]=[n("div",{class:"el-upload__tip"}," 支持多种格式文件，单个文件不超过10MB ",-1)])),default:o(()=>[r(t,{class:"el-icon--upload"},{default:o(()=>[r($(ie))]),_:1}),e[2]||(e[2]=n("div",{class:"el-upload__text"},[y(" 将文件拖到此处，或"),n("em",null,"点击上传")],-1))]),_:1,__:[2]},8,["file-list"]),i.value.length>0?(s(),_("div",Te,[r(f,{"content-position":"left"},{default:o(()=>e[3]||(e[3]=[y("文件列表")])),_:1,__:[3]}),n("div",Re,[(s(!0),_(G,null,j(i.value,(x,P)=>(s(),_("div",{key:P,class:"file-item"},[n("div",qe,[n("span",Ge,w(x.name),1),n("span",je,w(N(x.size)),1)]),n("div",Ke,[r(v,{modelValue:x.remark,"onUpdate:modelValue":M=>x.remark=M,placeholder:"请输入备注",style:{width:"200px"}},null,8,["modelValue","onUpdate:modelValue"]),r(a,{onCommand:M=>L(M,P),trigger:"click",placement:"bottom-end"},{dropdown:o(()=>[r(q,null,{default:o(()=>[(s(!0),_(G,null,j(F.value,M=>(s(),B(R,{key:M.value,command:M.value},{default:o(()=>[y(w(M.label),1)]),_:2},1032,["command"]))),128))]),_:1})]),default:o(()=>[r(g,{type:"primary",size:"small",style:{"margin-left":"8px"}},{default:o(()=>[e[4]||(e[4]=y(" 选择 ")),r(t,{class:"el-icon--right"},{default:o(()=>[r($(re))]),_:1})]),_:1,__:[4]})]),_:2},1032,["onCommand"])])]))),128))])])):z("",!0)])]),_:1},8,["modelValue","title"])}}},at=H(We,[["__scopeId","data-v-b86f4f56"]]);export{lt as A,at as a,he as u};
