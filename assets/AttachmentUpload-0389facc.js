import{r as G,_ as j}from"./index-e93e37ef.js";/* empty css                        *//* empty css                 */import{r as w,w as z,l as n,p as h,G as i,C as o,O as g,D as v,S as I,F as d,B as _,H as T,I as R,X,u as b,Q as q,aM as Y,aN as Z,E as B,J as ee,ar as te,a2 as K,aJ as le,K as O,M as W,j as ae,aw as oe,aO as se,aC as ne,aD as ie,a5 as re,aP as de,aQ as ue,aR as ce}from"./element-plus-eb4b90a0.js";import{f as pe}from"./format-20468769.js";/* empty css                     *//* empty css                   *//* empty css                    */function Qe(u){return G({url:`/api/admin/attachments/${u}`,method:"delete"})}function me(u,V,f){return G({url:`/api/admin/orders/${u}/upload?ref_id=${V}`,method:"post",data:f,headers:{"Content-Type":"multipart/form-data"}})}const _e={class:"attachment-list-container"},fe={class:"attachment-content"},ve={key:0,class:"empty-attachments"},he={key:1,class:"attachment-grid"},ge=["onClick"],ye={key:0,class:"image-preview"},ke=["src","alt"],we={key:1,class:"file-preview"},be={class:"file-icon"},Be={class:"file-type"},Me={class:"attachment-info"},xe=["title"],De={class:"file-meta"},Ee={class:"file-size"},Ve={key:0,class:"file-remark"},$e={class:"upload-time"},Ce={key:0,class:"attachment-checkbox"},Ie={class:"dialog-footer"},ze={__name:"AttachmentList",props:{visible:{type:Boolean,default:!1},title:{type:String,default:"附件列表"},attachments:{type:Array,default:()=>[]},orderId:{type:[String,Number],required:!0},refId:{type:[String,Number],default:0},type:{type:String,default:"general"},allowDelete:{type:Boolean,default:!0}},emits:["update:visible","refresh","delete"],setup(u,{emit:V}){const f=u,M=V,p=w(!1),c=w([]);z(()=>f.visible,t=>{p.value=t}),z(p,t=>{M("update:visible",t)});const $=t=>{var a;return t.file_type==="image"||((a=t.content_type)==null?void 0:a.startsWith("image/"))||/\.(jpg|jpeg|png|gif|bmp|webp|svg)$/i.test(t.file_name)},r=(t,a=200,l=200)=>`/api/admin/attachments/${t}/thumbnail?width=${a}&height=${l}`,x=t=>({document:"文档",image:"图片",video:"视频",audio:"音频",archive:"压缩包"})[t]||"文件",F=t=>{if(!t)return"0 B";const a=1024,l=["B","KB","MB","GB"],e=Math.floor(Math.log(t)/Math.log(a));return parseFloat((t/Math.pow(a,e)).toFixed(2))+" "+l[e]},S=t=>{const a=`/api/admin/attachments/${t.id}/view`;window.open(a,"_blank")},C=()=>{p.value=!1},A=async()=>{if(f.allowDelete){if(c.value.length===0){B.warning("请先选择要删除的附件");return}try{await ee.confirm(`确定要删除选中的 ${c.value.length} 个附件吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});for(const t of c.value)M("delete",t);c.value=[],B.success("删除成功"),M("refresh")}catch{}}},U=t=>{t.target.style.display="none";const a=t.target.parentElement;a&&(a.innerHTML=`
      <div class="file-preview">
        <div class="file-icon">
          <el-icon size="32">
            <Picture />
          </el-icon>
        </div>
        <div class="file-type">图片加载失败</div>
      </div>
    `)};return(t,a)=>{const l=te,e=K,m=le,y=O,N=W;return n(),h(N,{modelValue:p.value,"onUpdate:modelValue":a[1]||(a[1]=s=>p.value=s),title:u.title,width:"90%","before-close":C,center:""},{footer:i(()=>[o("span",Ie,[u.allowDelete&&c.value.length>0?(n(),h(y,{key:0,type:"danger",onClick:A},{default:i(()=>[g(" 删除选中 ("+v(c.value.length)+") ",1)]),_:1})):I("",!0),d(y,{onClick:C},{default:i(()=>a[2]||(a[2]=[g("关闭")])),_:1,__:[2]})])]),default:i(()=>[o("div",_e,[o("div",fe,[u.attachments.length===0?(n(),_("div",ve,[d(l,{description:"暂无附件"})])):(n(),_("div",he,[(n(!0),_(T,null,R(u.attachments,s=>(n(),_("div",{key:s.id,class:X(["attachment-item",{selected:c.value.includes(s.id)}])},[o("div",{class:"attachment-preview",onClick:D=>S(s)},[$(s)?(n(),_("div",ye,[o("img",{src:r(s.id),alt:s.file_name,class:"thumbnail-image",onError:U},null,40,ke)])):(n(),_("div",we,[o("div",be,[d(e,{size:"32"},{default:i(()=>[s.file_type==="document"?(n(),h(b(q),{key:0})):s.file_type==="image"?(n(),h(b(Y),{key:1})):s.file_type==="video"?(n(),h(b(Z),{key:2})):(n(),h(b(q),{key:3}))]),_:2},1024)]),o("div",Be,v(x(s.file_type)),1)]))],8,ge),o("div",Me,[o("div",{class:"file-name",title:s.file_name},v(s.file_name),9,xe),o("div",De,[o("span",Ee,v(F(s.file_size)),1),s.remark?(n(),_("span",Ve,v(s.remark),1)):I("",!0),o("span",$e,v(b(pe)(s.created_at)),1)])]),u.allowDelete?(n(),_("div",Ce,[d(m,{modelValue:c.value,"onUpdate:modelValue":a[0]||(a[0]=D=>c.value=D),value:s.id},null,8,["modelValue","value"])])):I("",!0)],2))),128))]))])])]),_:1},8,["modelValue","title"])}}},Xe=j(ze,[["__scopeId","data-v-a54ad4ea"]]);const Fe={class:"upload-content"},Se={key:0,class:"attachment-files"},Ae={class:"file-list"},Ue={class:"file-info"},Ne={class:"file-name"},Te={class:"file-size"},Re={class:"file-remark"},Le={class:"dialog-footer"},qe={__name:"AttachmentUpload",props:{visible:{type:Boolean,default:!1},title:{type:String,default:"上传附件"},orderId:{type:[String,Number],required:!0},refId:{type:[String,Number],required:!0},type:{type:String,default:"order"}},emits:["update:visible","success"],setup(u,{emit:V}){const f=u,M=V,p=w(!1),c=w(null),$=w(!1),r=w([]),x=w([]);z(()=>f.visible,l=>{p.value=l,l&&(r.value=[],x.value=[])}),z(p,l=>{M("update:visible",l)});const F=ae(()=>{switch(f.type){case"car":return[{value:"行驶证",label:"行驶证"},{value:"驾驶证",label:"驾驶证"},{value:"投保单",label:"投保单"},{value:"其他",label:"其他"}];case"cargo":return[{value:"运单",label:"运单"},{value:"发货单",label:"发货单"},{value:"货物清单",label:"货物清单"},{value:"投保单",label:"投保单"},{value:"其他",label:"其他"}];default:return[{value:"缴费通知书",label:"缴费通知书"},{value:"保单",label:"保单"},{value:"其他文件",label:"其他文件"}]}}),S=l=>{if(l.raw.size>10*1024*1024)return B.error("文件大小不能超过10MB"),!1;r.value.push({raw:l.raw,name:l.name,size:l.raw.size,remark:""})},C=l=>{const e=r.value.findIndex(m=>m.name===l.name);e!==-1&&r.value.splice(e,1)},A=(l,e)=>{e!==void 0&&r.value[e]&&(r.value[e].remark=l)},U=l=>{if(l===0)return"0 B";const e=1024,m=["B","KB","MB","GB"],y=Math.floor(Math.log(l)/Math.log(e));return parseFloat((l/Math.pow(e,y)).toFixed(2))+" "+m[y]},t=()=>{p.value=!1,r.value=[],x.value=[],c.value&&c.value.clearFiles()},a=async()=>{if(r.value.length===0){B.error("请选择要上传的文件");return}if(r.value.filter(e=>!e.remark.trim()).length>0){B.error("请为所有文件填写备注");return}$.value=!0;try{for(const e of r.value){const m=new FormData;m.append("files",e.raw),m.append("remarks",e.remark),await me(f.orderId,f.refId,m)}B.success("附件上传成功"),p.value=!1,r.value=[],x.value=[],M("success")}catch(e){B.error("附件上传失败："+(e.message||"未知错误"))}$.value=!1};return(l,e)=>{const m=K,y=ne,N=ie,s=re,D=O,H=de,J=ue,P=ce,Q=W;return n(),h(Q,{modelValue:p.value,"onUpdate:modelValue":e[0]||(e[0]=E=>p.value=E),title:u.title,width:"900px",center:""},{footer:i(()=>[o("span",Le,[d(D,{onClick:t},{default:i(()=>e[5]||(e[5]=[g("取消")])),_:1,__:[5]}),d(D,{type:"primary",onClick:a,loading:$.value,disabled:r.value.length===0},{default:i(()=>e[6]||(e[6]=[g(" 开始上传 ")])),_:1,__:[6]},8,["loading","disabled"])])]),default:i(()=>[o("div",Fe,[d(y,{ref_key:"uploadRef",ref:c,class:"upload-demo",drag:"",multiple:"","auto-upload":!1,limit:10,accept:"*/*","on-change":S,"on-remove":C,"file-list":x.value},{tip:i(()=>e[1]||(e[1]=[o("div",{class:"el-upload__tip"}," 支持多种格式文件，单个文件不超过10MB ",-1)])),default:i(()=>[d(m,{class:"el-icon--upload"},{default:i(()=>[d(b(oe))]),_:1}),e[2]||(e[2]=o("div",{class:"el-upload__text"},[g(" 将文件拖到此处，或"),o("em",null,"点击上传")],-1))]),_:1,__:[2]},8,["file-list"]),r.value.length>0?(n(),_("div",Se,[d(N,{"content-position":"left"},{default:i(()=>e[3]||(e[3]=[g("文件列表")])),_:1,__:[3]}),o("div",Ae,[(n(!0),_(T,null,R(r.value,(E,L)=>(n(),_("div",{key:L,class:"file-item"},[o("div",Ue,[o("span",Ne,v(E.name),1),o("span",Te,v(U(E.size)),1)]),o("div",Re,[d(s,{modelValue:E.remark,"onUpdate:modelValue":k=>E.remark=k,placeholder:"请输入备注",style:{width:"200px"}},null,8,["modelValue","onUpdate:modelValue"]),d(P,{onCommand:k=>A(k,L),trigger:"click",placement:"bottom-end"},{dropdown:i(()=>[d(J,null,{default:i(()=>[(n(!0),_(T,null,R(F.value,k=>(n(),h(H,{key:k.value,command:k.value},{default:i(()=>[g(v(k.label),1)]),_:2},1032,["command"]))),128))]),_:1})]),default:i(()=>[d(D,{type:"primary",size:"small",style:{"margin-left":"8px"}},{default:i(()=>[e[4]||(e[4]=g(" 选择 ")),d(m,{class:"el-icon--right"},{default:i(()=>[d(b(se))]),_:1})]),_:1,__:[4]})]),_:2},1032,["onCommand"])])]))),128))])])):I("",!0)])]),_:1},8,["modelValue","title"])}}},Ye=j(qe,[["__scopeId","data-v-60dfbdba"]]);export{Xe as A,Ye as a,Qe as d,me as u};
