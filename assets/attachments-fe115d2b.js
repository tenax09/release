import{r as E,_ as X,b as Y,u as Z}from"./index-49cf57c0.js";/* empty css               *//* empty css                *//* empty css                        *//* empty css                     *//* empty css                    *//* empty css                   *//* empty css                       */import{f as ee}from"./format-20468769.js";import{r as _,j as R,ae as te,l as v,B as U,C as o,F as a,D as m,G as l,af as ae,p as I,E as i,aE as le,ag as oe,ai as ne,u as B,aw as re,O as d,S as L,aG as se,J as de,a2 as ie,K as ue,aC as ce,al as pe,a5 as _e,an as me}from"./element-plus-f067b2d4.js";function fe(u){return E({url:"/api/admin/attachments",method:"get",params:u})}function he(u){return E({url:`/api/admin/attachments/${u}`,method:"delete"})}function ve(u,p,g){return E({url:`/api/admin/orders/${u}/upload?ref_id=${p}`,method:"post",data:g,headers:{"Content-Type":"multipart/form-data"}})}const ge={class:"attachments-page"},we={class:"page-header"},ye={class:"type-description"},ke={class:"upload-content"},be={class:"upload-actions"},Ce={class:"upload-drag-area"},xe={class:"upload-text"},Be={key:0,class:"upload-files"},Ee={class:"upload-files-header"},Fe={class:"upload-button"},De={class:"card-header"},Me={class:"total-count"},Ve={__name:"attachments",setup(u){const p=Y(),g=Z(),w=_(!1),y=_([]),F=p.params.id,k=p.query.ref_id,f=p.query.type,A=R(()=>{switch(f){case"car":return"车险附件管理";case"cargo":return"货运险附件管理";default:return"订单附件管理"}}),N=R(()=>{switch(f){case"car":return"仅显示该车险的专属附件(如行驶证、驾驶证、投保单、保单等)";case"cargo":return"仅显示该货运险的专属附件(如货物清单、运单、投保单、保单等)";default:return"显示所有附件(包括基础附件和所有保险附件)"}}),T=_(null),r=_([]),b=_(!1),q=()=>{g.back()},D=t=>t<1024?t+"B":t<1024*1024?(t/1024).toFixed(2)+"KB":t<1024*1024*1024?(t/(1024*1024)).toFixed(2)+"MB":(t/(1024*1024*1024)).toFixed(2)+"GB",C=async()=>{w.value=!0;try{const t={order_id:F};f!=="order"&&k&&(t.ref_id=k,t.type=f);const e=await fe(t);y.value=e.data}catch{i.error("获取附件列表失败")}w.value=!1},G=t=>t.size/1024/1024<10?!0:(i.error("文件大小不能超过 10MB!"),!1),S=t=>{window.open(`/api/admin/attachments/${t.id}`)},K=async t=>{try{await de.confirm("确定要删除该附件吗？","提示",{type:"warning"}),await he(t.id),i.success("删除成功"),C()}catch(e){e!=="cancel"&&i.error("删除失败")}},j=(t,e)=>{r.value=e.map(x=>({...x,remark:""}))},z=(t,e)=>{r.value=e},H=t=>{r.value.splice(t,1)},J=async()=>{if(!r.value.length){i.warning("请选择要上传的文件");return}b.value=!0;try{const t=new FormData;r.value.forEach(e=>{t.append("files",e.raw),t.append("remarks",e.remark||"")}),await ve(F,k||0,t),i.success("上传成功"),r.value=[],C()}catch(t){console.error("上传失败:",t),i.error("上传失败")}b.value=!1},O=()=>{r.value=[]};return te(()=>{C()}),(t,e)=>{const x=le,M=ie,c=ue,P=ce,s=pe,Q=_e,V=me,$=oe,W=ne;return v(),U("div",ge,[o("div",we,[a(x,{onBack:q,title:A.value},null,8,["title"]),o("div",ye,m(N.value),1)]),a($,{class:"upload-card"},{header:l(()=>e[0]||(e[0]=[o("div",{class:"card-header"},[o("span",null,"上传附件")],-1)])),default:l(()=>[o("div",ke,[o("div",be,[a(P,{ref_key:"uploadRef",ref:T,class:"upload-demo",action:"#","auto-upload":!1,"on-change":j,"on-remove":z,"before-upload":G,multiple:"",drag:""},{default:l(()=>[o("div",Ce,[a(M,{class:"el-icon--upload"},{default:l(()=>[a(B(re))]),_:1}),o("div",xe,[e[2]||(e[2]=o("span",null,"将文件拖到此处或",-1)),a(c,{type:"primary",link:""},{default:l(()=>e[1]||(e[1]=[d("点击上传")])),_:1,__:[1]})]),e[3]||(e[3]=o("div",{class:"el-upload__tip"}," 支持多个文件上传,单个文件不超过10MB ",-1))])]),_:1},512)]),r.value.length>0?(v(),U("div",Be,[o("div",Ee,[e[5]||(e[5]=o("h3",null,"待上传文件",-1)),r.value.length>0?(v(),I(c,{key:0,type:"danger",link:"",onClick:O},{default:l(()=>e[4]||(e[4]=[d(" 清空列表 ")])),_:1,__:[4]})):L("",!0)]),a(V,{data:r.value,border:"",style:{width:"100%"}},{default:l(()=>[a(s,{type:"index",label:"序号",width:"70",align:"center"}),a(s,{prop:"name",label:"文件名","min-width":"200","show-overflow-tooltip":""}),a(s,{prop:"size",label:"大小",width:"120",align:"right"},{default:l(n=>[d(m(D(n.row.size)),1)]),_:1}),a(s,{label:"备注","min-width":"200"},{default:l(n=>[a(Q,{modelValue:n.row.remark,"onUpdate:modelValue":h=>n.row.remark=h,placeholder:"请输入备注信息",clearable:""},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),a(s,{label:"操作",width:"80",fixed:"right",align:"center"},{default:l(n=>[a(c,{type:"danger",link:"",onClick:h=>H(n.$index)},{default:l(()=>e[6]||(e[6]=[d("移除")])),_:2,__:[6]},1032,["onClick"])]),_:1})]),_:1},8,["data"]),o("div",Fe,[a(c,{type:"primary",disabled:!r.value.length,loading:b.value,onClick:J,size:"large"},{default:l(()=>[a(M,null,{default:l(()=>[a(B(se))]),_:1}),e[7]||(e[7]=o("span",null,"开始上传",-1))]),_:1,__:[7]},8,["disabled","loading"])])])):L("",!0)])]),_:1}),ae((v(),I($,{class:"attachment-list-card"},{header:l(()=>[o("div",De,[e[8]||(e[8]=o("span",null,"附件列表",-1)),o("span",Me,"共 "+m(y.value.length)+" 个文件",1)])]),default:l(()=>[a(V,{data:y.value,border:"",style:{width:"100%"}},{default:l(()=>[a(s,{prop:"file_name",label:"文件名","min-width":"200"}),a(s,{prop:"file_size",label:"文件大小",width:"150"},{default:l(n=>[d(m(D(n.row.file_size)),1)]),_:1}),a(s,{prop:"remark",label:"备注","min-width":"200"}),a(s,{prop:"created_at",label:"上传时间",width:"180"},{default:l(n=>[d(m(B(ee)(n.row.created_at)),1)]),_:1}),a(s,{label:"操作",width:"150",fixed:"right"},{default:l(n=>[a(c,{type:"primary",link:"",onClick:h=>S(n.row)},{default:l(()=>e[9]||(e[9]=[d("下载")])),_:2,__:[9]},1032,["onClick"]),a(c,{type:"danger",link:"",onClick:h=>K(n.row)},{default:l(()=>e[10]||(e[10]=[d("删除")])),_:2,__:[10]},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})),[[W,w.value]])])}}},Se=X(Ve,[["__scopeId","data-v-5e8d2365"]]);export{Se as default};
