import{r as B,_ as Y,b as Z,u as ee}from"./index-2c2925e9.js";/* empty css               *//* empty css                *//* empty css                        *//* empty css                     *//* empty css                    *//* empty css                   *//* empty css                       */import{f as te}from"./format-20468769.js";import{r as m,j as R,ae,l as h,B as U,C as n,F as a,D as v,G as l,af as le,p as I,E as u,aE as oe,ag as ne,ai as re,u as x,aw as se,O as d,S as L,aG as de,J as ie,a2 as ue,K as ce,aC as pe,al as _e,a5 as me,an as fe}from"./element-plus-f067b2d4.js";function he(c){return B({url:"/api/admin/attachments",method:"get",params:c})}function ve(c){return B({url:`/api/admin/attachments/${c}`,method:"delete"})}function we(c,p,w){return B({url:`/api/admin/orders/${c}/upload?ref_id=${p}`,method:"post",data:w,headers:{"Content-Type":"multipart/form-data"}})}const ge={class:"attachments-page"},ye={class:"page-header"},ke={class:"type-description"},be={class:"upload-content"},Ce={class:"upload-actions"},xe={class:"upload-drag-area"},Be={class:"upload-text"},Ee={key:0,class:"upload-files"},Fe={class:"upload-files-header"},$e={class:"upload-button"},De={__name:"attachments",setup(c){const p=Z(),w=ee(),g=m(!1),E=m([]),F=p.params.id,y=p.query.ref_id,f=p.query.type,A=R(()=>{switch(f){case"car":return"车险附件管理";case"cargo":return"货运险附件管理";default:return"订单附件管理"}}),N=R(()=>{switch(f){case"car":return"仅显示该车险的专属附件(如行驶证、驾驶证、投保单、保单等)";case"cargo":return"仅显示该货运险的专属附件(如货物清单、运单、投保单、保单等)";default:return"显示所有附件(包括基础附件和所有保险附件)"}}),T=m(null),r=m([]),k=m(!1),q=()=>{w.back()},$=t=>t<1024?t+"B":t<1024*1024?(t/1024).toFixed(2)+"KB":t<1024*1024*1024?(t/(1024*1024)).toFixed(2)+"MB":(t/(1024*1024*1024)).toFixed(2)+"GB",b=async()=>{g.value=!0;try{const t={order_id:F};f!=="order"&&y&&(t.ref_id=y,t.type=f);const e=await he(t);E.value=e.data}catch{u.error("获取附件列表失败")}g.value=!1},G=t=>t.size/1024/1024<10?!0:(u.error("文件大小不能超过 10MB!"),!1),S=t=>{window.open(`/api/admin/attachments/${t.id}/download`)},K=t=>{window.open(`/api/admin/attachments/${t.id}/view`)},j=async t=>{try{await ie.confirm("确定要删除该附件吗？","提示",{type:"warning"}),await ve(t.id),u.success("删除成功"),b()}catch(e){e!=="cancel"&&u.error("删除失败")}},z=(t,e)=>{r.value=e.map(C=>({...C,remark:""}))},H=(t,e)=>{r.value=e},J=t=>{r.value.splice(t,1)},O=async()=>{if(!r.value.length){u.warning("请选择要上传的文件");return}k.value=!0;try{const t=new FormData;r.value.forEach(e=>{t.append("files",e.raw),t.append("remarks",e.remark||"")}),await we(F,y||0,t),u.success("上传成功"),r.value=[],b()}catch(t){console.error("上传失败:",t),u.error("上传失败")}k.value=!1},P=()=>{r.value=[]};return ae(()=>{b()}),(t,e)=>{const C=oe,D=ue,i=ce,Q=pe,s=_e,W=me,V=fe,M=ne,X=re;return h(),U("div",ge,[n("div",ye,[a(C,{onBack:q,title:A.value},null,8,["title"]),n("div",ke,v(N.value),1)]),a(M,{class:"upload-card"},{default:l(()=>[n("div",be,[n("div",Ce,[a(Q,{ref_key:"uploadRef",ref:T,class:"upload-demo",action:"#","auto-upload":!1,"on-change":z,"on-remove":H,"before-upload":G,multiple:"",drag:""},{default:l(()=>[n("div",xe,[a(D,{class:"el-icon--upload"},{default:l(()=>[a(x(se))]),_:1}),n("div",Be,[e[1]||(e[1]=n("span",null,"将文件拖到此处或",-1)),a(i,{type:"primary",link:""},{default:l(()=>e[0]||(e[0]=[d("点击上传")])),_:1,__:[0]})]),e[2]||(e[2]=n("div",{class:"el-upload__tip"}," 支持多个文件上传,单个文件不超过10MB ",-1))])]),_:1},512)]),r.value.length>0?(h(),U("div",Ee,[n("div",Fe,[e[4]||(e[4]=n("h3",null,"待上传文件",-1)),r.value.length>0?(h(),I(i,{key:0,type:"danger",link:"",onClick:P},{default:l(()=>e[3]||(e[3]=[d(" 清空列表 ")])),_:1,__:[3]})):L("",!0)]),a(V,{data:r.value,border:"",style:{width:"100%"}},{default:l(()=>[a(s,{type:"index",label:"序号",width:"70",align:"center"}),a(s,{prop:"name",label:"文件名","min-width":"200","show-overflow-tooltip":""}),a(s,{prop:"size",label:"大小",width:"120",align:"right"},{default:l(o=>[d(v($(o.row.size)),1)]),_:1}),a(s,{label:"备注","min-width":"200"},{default:l(o=>[a(W,{modelValue:o.row.remark,"onUpdate:modelValue":_=>o.row.remark=_,placeholder:"请输入备注信息",clearable:""},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),a(s,{label:"操作",width:"80",fixed:"right",align:"center"},{default:l(o=>[a(i,{type:"danger",link:"",onClick:_=>J(o.$index)},{default:l(()=>e[5]||(e[5]=[d("移除")])),_:2,__:[5]},1032,["onClick"])]),_:1})]),_:1},8,["data"]),n("div",$e,[a(i,{type:"primary",disabled:!r.value.length,loading:k.value,onClick:O,size:"large"},{default:l(()=>[a(D,null,{default:l(()=>[a(x(de))]),_:1}),e[6]||(e[6]=n("span",null,"开始上传",-1))]),_:1,__:[6]},8,["disabled","loading"])])])):L("",!0)])]),_:1}),le((h(),I(M,{class:"attachment-list-card"},{default:l(()=>[a(V,{data:E.value,border:"",style:{width:"100%"}},{default:l(()=>[a(s,{prop:"file_name",label:"文件名","min-width":"200"}),a(s,{prop:"file_size",label:"文件大小",width:"150"},{default:l(o=>[d(v($(o.row.file_size)),1)]),_:1}),a(s,{prop:"remark",label:"备注","min-width":"200"}),a(s,{prop:"created_at",label:"上传时间",width:"180"},{default:l(o=>[d(v(x(te)(o.row.created_at)),1)]),_:1}),a(s,{label:"操作",width:"180",fixed:"right"},{default:l(o=>[a(i,{type:"primary",link:"",onClick:_=>K(o.row)},{default:l(()=>e[7]||(e[7]=[d("查看")])),_:2,__:[7]},1032,["onClick"]),a(i,{type:"default",link:"",onClick:_=>S(o.row)},{default:l(()=>e[8]||(e[8]=[d("下载")])),_:2,__:[8]},1032,["onClick"]),a(i,{type:"danger",link:"",onClick:_=>j(o.row)},{default:l(()=>e[9]||(e[9]=[d("删除")])),_:2,__:[9]},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})),[[X,g.value]])])}}},Ge=Y(De,[["__scopeId","data-v-0c52a378"]]);export{Ge as default};
