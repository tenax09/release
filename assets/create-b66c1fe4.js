import{_ as _e,u as pe}from"./index-d5294a7a.js";/* empty css                   *//* empty css               *//* empty css                   *//* empty css                    *//* empty css                 *//* empty css                *//* empty css                             *//* empty css               *//* empty css                  *//* empty css                     */import{r as p,ae as ve,l as d,B as w,af as fe,p as C,G as a,E as v,a7 as me,ai as ge,F as s,H as U,I as V,O as c,D as _,S as D,C as r,u as Y,av as ye,aw as be,ax as he,ay as xe,a6 as we,ao as Ce,ah as ke,az as Ee,aA as De,ag as Ie,aB as Ne,a2 as Ue,K as Ve,aC as Fe,aD as Be,am as Le}from"./element-plus-b8725afa.js";import{g as Re,c as Me,e as Te}from"./order-7640752e.js";import{g as Se,a as $e}from"./user-a6bbf2be.js";const ze={class:"order-edit"},Oe={class:"upload-section"},Ye={class:"upload-tips"},je={class:"upload-actions"},qe={key:0,class:"import-result"},Ae={class:"result-summary"},We={class:"stat-item"},Ge={class:"stat-number total"},He={class:"stat-item"},Ke={class:"stat-number success"},Je={class:"stat-item"},Pe={class:"stat-number fail"},Qe={key:0,class:"error-list"},Xe={class:"form-actions"},Ze={__name:"create",setup(el){const S=pe(),F=p(null),j=p(!1),B=p(!1),E=p([]),h=p([]),L=p(!1),R=p([]),f=p(null),g=p([]),u=p(null),M=p(null),k=p(null),q=p([]),b=p(null),i=p({user_id:void 0,user_config_id:void 0,insurer_id:void 0}),A={user_id:[{required:!0,message:"请选择用户",trigger:"change"}],user_config_id:[{required:!0,message:"请选择用户配置",trigger:"change"}],insurer_id:[{required:!0,message:"请选择保险公司",trigger:"change"}]},W=async()=>{try{const l=await Re();h.value=l.data.list,E.value=l.data.list}catch{v.error("获取保险公司列表失败")}},$=l=>{if(!l||!l.insurer_ids||!h.value.length){E.value=h.value;return}const e=l.insurer_ids.split(",").map(n=>parseInt(n.trim())).filter(n=>!isNaN(n));E.value=h.value.filter(n=>e.includes(n.id)),i.value.insurer_id&&!e.includes(i.value.insurer_id)&&(i.value.insurer_id=void 0)},G=async()=>{if(!f.value){g.value=[],u.value=null;return}g.value=f.value.configs||[],g.value.length===0?(v.warning("该用户未配置任何产品，无法创建订单"),u.value=null,i.value.user_config_id=void 0):(u.value=g.value[0],i.value.user_config_id=g.value[0].id)},H=l=>{if(!l)return"";let e=l.name||"";if(l.account_no&&l.account_no.length>=4){const n=l.account_no.slice(-4);e+=` (${n})`}return e},K=l=>{var n;if(!l)return"";const e=[];return(n=l.product)!=null&&n.name&&e.push(l.product.name),l.sell_mode&&e.push(l.sell_mode),l.insurance_type&&e.push(l.insurance_type),l.seller&&e.push(l.seller),e.join(" - ")||"未命名配置"},J=l=>!l||!h.value.length?"":l.split(",").map(o=>parseInt(o.trim())).filter(o=>!isNaN(o)).map(o=>{const m=h.value.find(x=>x.id===o);return m?m.name:""}).filter(o=>o).join("、"),P=l=>!l||l.trim()===""?"未设置":l.split(";").map(n=>n.split(",")[0]||"").filter(n=>n.trim()!=="").join("、")||"未设置",Q=async l=>{if(l){L.value=!0;try{const e=await Se({keyword:l,status:"审核通过",page:1,pageSize:20});R.value=e.data.list}catch{v.error("搜索用户失败")}L.value=!1}else R.value=[]},X=async l=>{if(!l){f.value=null,i.value.user_config_id=void 0,i.value.insurer_id=void 0,u.value=null,g.value=[],E.value=h.value;return}try{const e=await $e(l);f.value=e.data,$(e.data),await G()}catch(e){v.error("获取用户详情失败:"+e.message),f.value=null,i.value.user_config_id=void 0,i.value.insurer_id=void 0,u.value=null,g.value=[],E.value=h.value}},Z=l=>{if(!l){u.value=null,i.value.insurer_id=void 0;return}const e=g.value.find(n=>n.id===l);if(e)if(u.value=e,$(f.value),f.value.insurer_ids){const n=f.value.insurer_ids.split(",").map(o=>parseInt(o.trim())).filter(o=>!isNaN(o));n.length===1?i.value.insurer_id=n[0]:i.value.insurer_id=void 0}else i.value.insurer_id=void 0;else u.value=null,i.value.insurer_id=void 0},ee=async()=>{if(!u.value){v.error("请先选择用户配置");return}window.open(`/api/admin/orders/insurances/download-template?type=${u.value.insurance_type}`,"_blank")},le=l=>{if(k.value=l.raw,b.value=null,!["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel"].includes(l.raw.type)&&!l.name.toLowerCase().endsWith(".xlsx")&&!l.name.toLowerCase().endsWith(".xls")){v.error("请上传Excel文件(.xlsx或.xls)"),M.value.clearFiles(),k.value=null;return}if(l.raw.size>10*1024*1024){v.error("文件大小不能超过10MB"),M.value.clearFiles(),k.value=null;return}},ae=async l=>{if(!k.value)return null;const e=new FormData;e.append("file",k.value);try{return(await Te(l,e)).data}catch(n){return v.error("批量导入失败："+(n.message||"未知错误")),null}},se=()=>{S.back()},te=async()=>{F.value&&await F.value.validate(async l=>{if(l){if(!u.value){v.error("请选择用户配置");return}B.value=!0;try{const e={user_id:i.value.user_id,user_config_id:i.value.user_config_id,insurer_id:i.value.insurer_id},o=(await Me(e)).data.id;if(v.success("订单创建成功"),k.value){v.info("开始导入投保信息...");const m=await ae(o);m&&(b.value=m,m.success>0?(v.success(`投保信息导入完成：成功${m.success}条，失败${m.fail}条`),setTimeout(()=>{S.push(`/order/detail/${o}`)},3e3)):v.warning("没有成功导入任何投保信息，请检查文件格式"))}}catch(e){v.error("创建失败："+(e.message||"未知错误"))}B.value=!1}})};return ve(()=>{W()}),(l,e)=>{const n=he,o=xe,m=we,x=Ce,N=ke,y=Ee,z=De,I=Ie,ne=Ne,O=Ue,T=Ve,re=Fe,ue=Be,ie=Le,oe=me,de=ge;return d(),w("div",ze,[fe((d(),C(oe,{ref_key:"formRef",ref:F,model:i.value,rules:A,"label-width":"120px",class:"edit-form"},{default:a(()=>[s(I,{class:"form-card"},{default:a(()=>[s(N,{gutter:20},{default:a(()=>[s(x,{span:24},{default:a(()=>[s(m,{label:"借款人",prop:"user_id"},{default:a(()=>[s(o,{modelValue:i.value.user_id,"onUpdate:modelValue":e[0]||(e[0]=t=>i.value.user_id=t),filterable:"",remote:"","reserve-keyword":"",placeholder:"请输入用户名或企业名称搜索","remote-method":Q,loading:L.value,onChange:X},{default:a(()=>[(d(!0),w(U,null,V(R.value,t=>(d(),C(n,{key:t.id,label:t.company_name+" ("+t.username+")("+t.status+")("+t.audit_status+")",value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1})]),_:1})]),_:1}),f.value?(d(),C(z,{key:0,column:2,border:""},{default:a(()=>[s(y,{span:2,label:"关联保险公司"},{default:a(()=>[c(_(J(f.value.insurer_ids)||"未设置"),1)]),_:1}),s(y,{span:2,label:"被保人"},{default:a(()=>[c(_(P(f.value.insureds)||"未设置"),1)]),_:1})]),_:1})):D("",!0)]),_:1}),s(I,{class:"form-card"},{default:a(()=>[s(N,{gutter:20},{default:a(()=>[s(x,{span:24},{default:a(()=>[s(m,{label:"用户配置",prop:"user_config_id"},{default:a(()=>[s(o,{modelValue:i.value.user_config_id,"onUpdate:modelValue":e[1]||(e[1]=t=>i.value.user_config_id=t),placeholder:"请选择用户配置",onChange:Z,clearable:"",filterable:"",disabled:!f.value||!g.value.length},{default:a(()=>[(d(!0),w(U,null,V(g.value,t=>(d(),C(n,{key:t.id,label:K(t),value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}),u.value?(d(),C(z,{key:0,column:3,border:""},{default:a(()=>[s(y,{span:3,label:"产品"},{default:a(()=>{var t;return[c(_(((t=u.value.product)==null?void 0:t.name)||"-"),1)]}),_:1}),u.value.sell_mode==="渠道"?(d(),C(y,{key:0,span:3,label:"渠道商"},{default:a(()=>{var t;return[c(_(((t=u.value.agent)==null?void 0:t.company_name)||"-"),1)]}),_:1})):D("",!0),s(y,{label:"销售模式"},{default:a(()=>[c(_(u.value.sell_mode),1)]),_:1}),s(y,{label:"险种"},{default:a(()=>[c(_(u.value.insurance_type||"-"),1)]),_:1}),s(y,{label:"销售员"},{default:a(()=>[c(_(u.value.seller||"-"),1)]),_:1}),s(y,{label:"服务费"},{default:a(()=>[c(_(u.value.service_fee)+"%",1)]),_:1}),u.value.sell_mode==="渠道"?(d(),C(y,{key:1,label:"渠道成本"},{default:a(()=>[c(_(u.value.agent_cost)+"%",1)]),_:1})):D("",!0),s(y,{label:"过期时间"},{default:a(()=>[c(_(u.value.overdue_date||"-"),1)]),_:1})]),_:1})):D("",!0)]),_:1}),s(I,{class:"form-card"},{default:a(()=>[s(N,{gutter:20},{default:a(()=>[s(x,{span:24},{default:a(()=>[s(m,{label:"保险公司",prop:"insurer_id"},{default:a(()=>[s(o,{modelValue:i.value.insurer_id,"onUpdate:modelValue":e[2]||(e[2]=t=>i.value.insurer_id=t),placeholder:"请选择保险公司",clearable:"",filterable:"",disabled:!f.value},{default:a(()=>[(d(!0),w(U,null,V(E.value,t=>(d(),C(n,{key:t.id,label:H(t),value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1})]),_:1}),s(I,{class:"form-card"},{header:a(()=>e[3]||(e[3]=[r("div",{class:"card-header"},[r("h4",null,"批量导入投保信息"),r("span",{class:"header-tip"},"（可选，也可以在创建订单后再上传）")],-1)])),default:a(()=>[r("div",Oe,[r("div",Ye,[s(ne,{title:"导入说明",type:"info","show-icon":"",closable:!1},{default:a(()=>e[4]||(e[4]=[r("div",{class:"tips-content"},[r("p",null,"1. 请先选择用户配置，然后下载对应的Excel模板"),r("p",null,"2. 按照模板格式填写投保信息数据"),r("p",null,"3. 支持 .xlsx 和 .xls 格式文件，文件大小不超过10MB"),r("p",null,"4. 必填字段不能为空，金额字段请填写数字"),r("p",null,"5. 日期格式：YYYY-MM-DD，如：2024-01-01")],-1)])),_:1,__:[4]})]),r("div",je,[s(T,{onClick:ee,disabled:!u.value,type:"primary",plain:""},{default:a(()=>{var t;return[s(O,null,{default:a(()=>[s(Y(ye))]),_:1}),c(" 下载"+_(((t=u.value)==null?void 0:t.insurance_type)||"保险")+"模板 ",1)]}),_:1},8,["disabled"]),e[5]||(e[5]=r("span",{class:"action-tip"},"请先选择用户配置",-1))]),s(re,{ref_key:"excelUploadRef",ref:M,class:"upload-demo",drag:"","auto-upload":!1,limit:1,accept:".xlsx,.xls","on-change":le,"file-list":q.value},{tip:a(()=>e[6]||(e[6]=[r("div",{class:"el-upload__tip"}," 只能上传 .xlsx/.xls 文件，且不超过 10MB ",-1)])),default:a(()=>[s(O,{class:"el-icon--upload"},{default:a(()=>[s(Y(be))]),_:1}),e[7]||(e[7]=r("div",{class:"el-upload__text"},[c(" 将Excel文件拖到此处，或"),r("em",null,"点击上传")],-1))]),_:1,__:[7]},8,["file-list"]),b.value?(d(),w("div",qe,[s(I,null,{header:a(()=>e[8]||(e[8]=[r("span",null,"导入结果",-1)])),default:a(()=>[r("div",Ae,[s(N,{gutter:20},{default:a(()=>[s(x,{span:8},{default:a(()=>[r("div",We,[r("div",Ge,_(b.value.total),1),e[9]||(e[9]=r("div",{class:"stat-label"},"总数",-1))])]),_:1}),s(x,{span:8},{default:a(()=>[r("div",He,[r("div",Ke,_(b.value.success),1),e[10]||(e[10]=r("div",{class:"stat-label"},"成功",-1))])]),_:1}),s(x,{span:8},{default:a(()=>[r("div",Je,[r("div",Pe,_(b.value.fail),1),e[11]||(e[11]=r("div",{class:"stat-label"},"失败",-1))])]),_:1})]),_:1})]),b.value.errors&&b.value.errors.length>0?(d(),w("div",Qe,[s(ue,{"content-position":"left"},{default:a(()=>e[12]||(e[12]=[c("错误详情")])),_:1,__:[12]}),(d(!0),w(U,null,V(b.value.errors,(t,ce)=>(d(),w("div",{class:"error-item",key:ce},[s(ie,{type:"danger",size:"small"},{default:a(()=>[c(_(t),1)]),_:2},1024)]))),128))])):D("",!0)]),_:1})])):D("",!0)])]),_:1}),r("div",Xe,[s(T,{onClick:se},{default:a(()=>e[13]||(e[13]=[c("取消")])),_:1,__:[13]}),s(T,{type:"primary",onClick:te,loading:B.value},{default:a(()=>[c(_(k.value?"创建订单并导入投保信息":"创建订单"),1)]),_:1},8,["loading"])])]),_:1},8,["model"])),[[de,j.value]])])}}},fl=_e(Ze,[["__scopeId","data-v-aa2aa3c7"]]);export{fl as default};
